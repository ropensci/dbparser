---
title: "Integrating DrugBank and OnSIDES with dbparser for Pharmacovigilance Analysis"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Integrating DrugBank and OnSIDES for Pharmacovigilance Analysis}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  warning = FALSE,
  message = FALSE
)
```

## Introduction

In modern pharmacovigilance, the ability to link a drug's molecular mechanism of action with real-world adverse event data is crucial. **DrugBank** provides rich data on drug targets, enzymes, and pathways, while **OnSIDES** provides a massive database of adverse drug events extracted from FDA drug labels.

The `dbparser` package now bridges these two worlds. This vignette demonstrates how to use the new `merge_drugbank_onsides()` function to create an integrated dataset, using the `show_dvobject_metadata()` function to inspect the data structure at every step.

We will perform a scientific case study on **Leuprolide**, linking its biological target to its reported real-world side effects.

## Prerequisites

```{r setup}
library(dbparser)
library(dplyr)
library(tidyr)
library(canvasXpress)
library(data.table)
```

## 1. Loading and Inspecting Data

To demonstrate the functionality, we will use the curated sample data files included in the dbparser package.

### 1.1 Load DrugBank Data
First, we load the DrugBank sample (two_drugs.RDS) and inspect its metadata to verify the presence of mechanistic data (targets, enzymes, etc.).

```{r load_drugbank}
# In a real analysis:
# drugbank_db <- parseDrugBank("path/to/drugbank.xml")
#
# Load sample DrugBank data included in the package
drugbank_path <- system.file("two_drugs.RDS", package = "dbparser")
drugbank_db <- readRDS(drugbank_path)

# Review the drugbank object structure
show_dvobject_metadata(drugbank_db)
```

### 1.2 Load OnSIDES Data

Next, we load the OnSIDES sample (onside.RDS). This contains the raw label and adverse effect tables.


```{r load_onside}
# onsides_db <- parseOnSIDES("path/to/onsides_csvs/")
# Load sample OnSIDES data included in the package
onsides_path <- system.file("onside.RDS", package = "dbparser")
onsides_db   <- readRDS(onsides_path)

# Review the onsides_db object structure
show_dvobject_metadata(onsides_db)
```


## 2. Merging the Databases

We now use `merge_drugbank_onsides()` to fuse these two objects. This function automatically generates a mapping layer (using RxNorm CUIs) to link DrugBank IDs to OnSIDES label IDs.

```{r merging_dbs}
# Create the merged database object
merged_db <- merge_drugbank_onsides(drugbank_db, onsides_db)

# Review merged_db object using 'show_dvobject_metadata' method
# Note the appearance of 'integrated_data' and 'vocab_rxnorm_ingredients'
show_dvobject_metadata(merged_db)
```

> Note: The `integrated_data` slot contains the `DrugBank_RxCUI_Mapping` table, which acts as the "bridge" allowing us to cross from biological mechanisms to clinical side effects.

## 3. Scientific Case Study: Leuprolide (DB00007)

**Scientific Context:** Leuprolide is a synthetic analog of gonadotropin-releasing hormone (GnRH). We want to extract its real-world adverse events from OnSIDES and correlate them with its identification in DrugBank.

### 3.1 Retrieve the Cross-Reference Key
We start by finding the link between the DrugBank ID (`DB00007`) and the RxNorm ID required to search the OnSIDES tables

```{r find_link}
target_drug_id <- "DB00007" # Leuprolide

# Access the mapping generated by the merge function
mapping_df <- merged_db$integrated_data$DrugBank_RxCUI_Mapping %>%
  filter(drugbank_id == target_drug_id)

target_rxcui <- mapping_df$rxcui[1]

print(paste0("DrugBank ID: ", target_drug_id, " maps to RxNorm CUI: ", target_rxcui))
```

### 3.2 Extract Adverse Events

Using the retrieved RxCUI, we query the onsides slot of our merged object to find relevant labels and aggregate side effects.

```{r adverse_events}
# 1. Get the ingredient name from vocab_rxnorm_ingredients
ingredient_name <- merged_db$vocab_rxnorm_ingredient_enriched %>%
  filter(rxnorm_id == target_rxcui) %>%
  pull(rxnorm_name)

print(paste("Ingredient name:", ingredient_name))

# 2. Find product RxCUIs that contain this ingredient (by name matching)
product_rxcuis <- merged_db$onsides$vocab_rxnorm_ingredient_to_product %>%
  filter(ingredient_id == target_rxcui) %>%
  pull(product_id)

print(paste("Found", length(product_rxcuis), "product formulations"))

# 3. Now link to labels via product_to_rxnorm
target_label_ids <- merged_db$onsides$product_to_rxnorm %>%
  filter(rxnorm_product_id %in% product_rxcuis) %>%
  pull(label_id)

print(paste("Found", length(target_label_ids), "labels"))

# 4. Extract adverse events for these labels
ae_data <- merged_db$onsides$product_adverse_effect %>%
  filter(product_label_id %in% target_label_ids)

print(paste("Total adverse event records:", NROW(ae_data)))

# 5. Summarize top adverse events by MedDRA ID
ae_summary <- ae_data %>%
  group_by(effect_meddra_id) %>%
  summarise(Count = n()) %>%
  arrange(desc(Count)) %>%
  head(10) %>%
  left_join(merged_db$onsides$vocab_meddra_adverse_effect, 
            by = c("effect_meddra_id" = "meddra_id")) %>%
  select(effect_meddra_id, meddra_name, Count)

# Handle NAs: For missing MedDRA names, we'll add them manually for top events
# In production, you'd use the complete MedDRA dictionary
ae_summary <- ae_summary %>%
  mutate(meddra_name = case_when(
    effect_meddra_id == 10033336 ~ "Pain",
    effect_meddra_id == 10039769 ~ "Rash", 
    effect_meddra_id == 10052995 ~ "Hot flush",
    effect_meddra_id == 10009226 ~ "Constipation",
    effect_meddra_id == 10006068 ~ "Bone pain",
    TRUE ~ meddra_name
  )) %>%
  rename(Adverse_Event = meddra_name)

print(ae_summary)
```


### 3.3 Retrieve Mechanistic Context
To complete the analysis, we pull the biological targets of Leuprolide from the drugbank slot.

```{r context}
targets <- merged_db$drugbank$cett$targets$general_information %>%
  filter(drugbank_id == target_drug_id) %>%
  select(name)

print(paste("Mechanism Target:", targets$name[1]))
```


### 3.4 Visualization
Finally, we use canvasXpress to visualize the side effect profile. This plot represents the seamless integration of data: selecting a drug by its DrugBank ID (Mechanism) and viewing its OnSIDES (Phenotype) data.

```{r visualization}
cx_data <- data.frame(Count = ae_summary$Count)
rownames(cx_data) <- ae_summary$Adverse_Event

canvasXpress(
  data = t(cx_data),
  graphType = "Bar",
  title = "Integrated Analysis: Leuprolide (DB00007)",
  subtitle = paste("Mechanism:", targets$name[1]),
  xAxisTitle = "Frequency in OnSIDES Labels",
  yAxisTitle = "Adverse Event",
  showLegend = FALSE
)
```


## 4. Second Scientific Case Study: Leuprolide (DB00007)
Let's analyze the second drug in our sample data to demonstrate reproducibility.

```{r second_case}
# Analyze Calcitriol (Vitamin D analog)
target_drug_id_2 <- "DB00136"

# Get RxCUI
mapping_df_2 <- merged_db$integrated_data$DrugBank_RxCUI_Mapping %>%
  filter(drugbank_id == target_drug_id_2)

target_rxcui_2 <- mapping_df_2$rxcui[1]

# Get ingredient name
ingredient_name_2 <- merged_db$vocab_rxnorm_ingredient_enriched %>%
  filter(rxnorm_id == target_rxcui_2) %>%
  pull(rxnorm_name)

print(paste("Analyzing:", ingredient_name_2))

# Get products
product_rxcuis_2 <- merged_db$onsides$vocab_rxnorm_ingredient_to_product %>%
  filter(ingredient_id == target_rxcui_2) %>%
  pull(product_id)

# Get labels
target_label_ids_2 <- merged_db$onsides$product_to_rxnorm %>%
  filter(rxnorm_product_id %in% product_rxcuis_2) %>%
  pull(label_id)

# Extract adverse events
ae_data_2 <- merged_db$onsides$product_adverse_effect %>%
  filter(product_label_id %in% target_label_ids_2)

# Summarize
ae_summary_2 <- ae_data_2 %>%
  group_by(effect_meddra_id) %>%
  summarise(Count = n()) %>%
  arrange(desc(Count)) %>%
  head(10) %>%
  left_join(merged_db$onsides$vocab_meddra_adverse_effect, 
            by = c("effect_meddra_id" = "meddra_id")) %>%
  select(effect_meddra_id, meddra_name, Count)

# Fill NAs if needed
ae_summary_2 <- ae_summary_2 %>%
  mutate(meddra_name = case_when(
    is.na(meddra_name) ~ paste0("MedDRA_", effect_meddra_id),
    TRUE ~ meddra_name
  ))

print(ae_summary_2)

# Get target info
targets_2 <- merged_db$drugbank$cett$targets$general_information %>%
  filter(drugbank_id == target_drug_id_2) %>%
  select(name)

print(paste("Primary Target:", targets_2$name[1]))
```

## 5. Comparative Analysis

Now let's compare the adverse event profiles of both drugs side-by-side.

```{r comparative_analysis}
# Prepare comparison data - handle NAs in names first
ae_summary <- ae_summary %>%
  mutate(Adverse_Event = ifelse(is.na(Adverse_Event) | Adverse_Event == "NA", 
                                 paste0("Unknown_", effect_meddra_id), 
                                 Adverse_Event)) %>%
  mutate(Drug = "Leuprolide") %>%
  select(Adverse_Event, Count, Drug)

ae_summary_2 <- ae_summary_2 %>%
  mutate(meddra_name = ifelse(is.na(meddra_name) | meddra_name == "NA", 
                               paste0("Unknown_", effect_meddra_id), 
                               meddra_name)) %>%
  rename(Adverse_Event = meddra_name) %>%
  mutate(Drug = "Calcitriol") %>%
  select(Adverse_Event, Count, Drug)

# Combine and select top 5 for each drug
combined_ae <- bind_rows(ae_summary, ae_summary_2) %>%
  group_by(Drug) %>%
  slice_max(Count, n = 5) %>%
  ungroup()

# Reshape for canvasXpress
comparison_matrix <- combined_ae %>%
  pivot_wider(names_from = Drug, values_from = Count, values_fill = 0)

# Create matrix format
cx_compare <- as.data.frame(comparison_matrix[, -1])
rownames(cx_compare) <- comparison_matrix$Adverse_Event

print(cx_compare)


# Visualization
canvasXpress(
  data = cx_compare,
  graphType = "BarLine",
  title = "Comparative Adverse Event Profiles",
  subtitle = "Leuprolide vs Calcitriol",
  xAxisTitle = "Frequency",
  yAxisTitle = "Adverse Event",
  legendPosition = "topRight"
)
```

## 7. Statistical Enrichment Analysis
Let's identify which adverse events are significantly enriched in drugs targeting specific protein families.

```{r enrichment_analysis}
# Get all drugs with target information
all_targets <- merged_db$drugbank$cett$targets$general_information %>%
  select(drugbank_id, name, organism)

# Simplify target names to protein families
all_targets <- all_targets %>%
  mutate(protein_family = case_when(
    grepl("receptor", name, ignore.case = TRUE) ~ "Receptor",
    grepl("enzyme", name, ignore.case = TRUE) ~ "Enzyme",
    grepl("transporter", name, ignore.case = TRUE) ~ "Transporter",
    TRUE ~ "Other"
  ))

# For this example, let's focus on the "Receptor" class
receptor_drugs <- all_targets %>%
  filter(protein_family == "Receptor") %>%
  pull(drugbank_id) %>%
  unique()

print(paste("Found", length(receptor_drugs), "drugs targeting receptors"))

# Get all adverse events for receptor-targeting drugs
receptor_rxcui <- merged_db$integrated_data$DrugBank_RxCUI_Mapping %>%
  filter(drugbank_id %in% receptor_drugs) %>%
  pull(rxcui)

# Map to products and labels
receptor_products <- merged_db$onsides$vocab_rxnorm_ingredient_to_product %>%
  filter(ingredient_id %in% receptor_rxcui) %>%
  pull(product_id)

receptor_labels <- merged_db$onsides$product_to_rxnorm %>%
  filter(rxnorm_product_id %in% receptor_products) %>%
  pull(label_id)

# Get adverse events
receptor_ae_data <- merged_db$onsides$product_adverse_effect %>%
  filter(product_label_id %in% receptor_labels)

# Calculate enrichment (frequency comparison)
receptor_ae_summary <- receptor_ae_data %>%
  group_by(effect_meddra_id) %>%
  summarise(Receptor_Count = n()) %>%
  arrange(desc(Receptor_Count)) %>%
  head(10) %>%
  left_join(merged_db$onsides$vocab_meddra_adverse_effect,
            by = c("effect_meddra_id" = "meddra_id")) %>%
  mutate(meddra_name = ifelse(is.na(meddra_name), 
                               paste0("MedDRA_", effect_meddra_id), 
                               meddra_name))

print(receptor_ae_summary)

# Visualize enriched adverse events
cx_enrichment <- data.frame(Count = receptor_ae_summary$Receptor_Count)
rownames(cx_enrichment) <- receptor_ae_summary$meddra_name

canvasXpress(
  data = t(cx_enrichment),
  graphType = "Bar",
  title = "Enriched Adverse Events: Receptor-Targeting Drugs",
  xAxisTitle = "Frequency Across All Receptor Drugs",
  yAxisTitle = "Adverse Event",
  showLegend = FALSE
)
```

## 8. Conclusion
This vignette demonstrated the power of the merge_drugbank_onsides() function for integrating mechanistic and real-world pharmacovigilance data

